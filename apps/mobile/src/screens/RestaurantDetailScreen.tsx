import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import {
  View,
  StyleSheet,
  ScrollView,
  RefreshControl,
} from 'react-native';
import { useRoute, RouteProp } from '@react-navigation/native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import {
  useTheme,
  useSocket,
  THEME_COLORS,
  useReviews,
  useMenus,
} from 'shared';
import type { RestaurantStackParamList } from '../navigation/types';

// Extracted components
import RestaurantDetailHeader from './RestaurantDetail/header/RestaurantDetailHeader';
import CrawlProgressCard from './RestaurantDetail/progress/CrawlProgressCard';
import SummaryProgressCard from './RestaurantDetail/progress/SummaryProgressCard';
import TabMenu from './RestaurantDetail/navigation/TabMenu';
import ReviewFilterBar from './RestaurantDetail/filters/ReviewFilterBar';
import { MenuTab } from './RestaurantDetail/tabs/MenuTab';
import { ReviewTab } from './RestaurantDetail/tabs/ReviewTab';
import { StatisticsTab } from './RestaurantDetail/tabs/StatisticsTab';
import MapTab from './RestaurantDetail/tabs/MapTab';
import ImageViewer from './RestaurantDetail/modals/ImageViewer';
import { ResummaryModal } from './RestaurantDetail/modals/ResummaryModal';

// Hooks
import {
  useKeywordToggle,
  useImageViewer,
  useRefreshControl,
  useMenuStatistics,
  useResummary,
  useScrollToTop,
} from './RestaurantDetail/hooks';

// Utils
import { renderStars } from './RestaurantDetail/utils/starRating';
import { openNaverMap } from './RestaurantDetail/utils/openNaverMap';

// Types
import type { TabType } from './RestaurantDetail/tabs/types';
import type { RestaurantData, ReviewData } from 'shared';

type RestaurantDetailRouteProp = RouteProp<RestaurantStackParamList, 'RestaurantDetail'>;

// Type conversion helpers
const convertRestaurant = (data: RestaurantData) => ({
  name: data.name,
  category: data.category ?? undefined,
  address: data.address ?? undefined,
});

const convertReview = (data: ReviewData) => ({
  id: data.id,
  userName: data.userName ?? undefined,
  visitInfo: {
    visitDate: data.visitInfo.visitDate ?? undefined,
    visitCount: data.visitInfo.visitCount ?? undefined,
    verificationMethod: data.visitInfo.verificationMethod ?? undefined,
  },
  visitKeywords: data.visitKeywords,
  reviewText: data.reviewText ?? undefined,
  images: data.images,
  summary: data.summary ? {
    sentiment: data.summary.sentiment,
    summary: data.summary.summary,
    keyKeywords: data.summary.keyKeywords,
    satisfactionScore: data.summary.satisfactionScore,
    menuItems: data.summary.menuItems,
    tips: data.summary.tips,
    sentimentReason: data.summary.sentimentReason,
  } : undefined,
  emotionKeywords: data.emotionKeywords,
  waitTime: data.waitTime ?? undefined,
});

const RestaurantDetailScreen: React.FC = () => {
  const route = useRoute<RestaurantDetailRouteProp>();
  const { restaurantId, restaurant } = route.params;

  const { theme } = useTheme();
  const colors = THEME_COLORS[theme];
  const insets = useSafeAreaInsets();

  const {
    menuProgress,
    crawlProgress,
    dbProgress,
    imageProgress,
    reviewSummaryStatus,
    summaryProgress,
    joinRestaurantRoom,
    leaveRestaurantRoom,
    setRestaurantCallbacks,
    resetCrawlStatus,
    resetSummaryStatus
  } = useSocket();

  // ÌÅ¨Î°§ÎßÅ Ï§ëÏù∏ÏßÄ Ï≤¥ÌÅ¨
  const isCrawling = menuProgress !== null || crawlProgress !== null || dbProgress !== null || imageProgress !== null;

  // ÌÅ¨Î°§ÎßÅ ÏôÑÎ£å Ï∂îÏ†Å (wasCrawling)
  const wasCrawling = useRef(false);

  // ÌÉ≠ ÏÉÅÌÉú Í¥ÄÎ¶¨
  const [activeTab, _setActiveTab] = useState<TabType>('menu');

  // ScrollView ref Ï∂îÍ∞Ä
  const scrollViewRef = useRef<ScrollView>(null);

  // shared ÌõÖ ÏÇ¨Ïö© (ÌîåÎû´Ìèº ÎèÖÎ¶ΩÏ†Å)
  const {
    reviews,
    reviewsLoading,
    reviewsLoadingMore,
    reviewsTotal,
    hasMoreReviews,
    sentimentFilter,
    searchText,
    fetchReviews,
    loadMoreReviews,
    changeSentimentFilter,
    setSearchText,
    changeSearchText,
  } = useReviews();

  const {
    menus,
    menusLoading,
    fetchMenus,
  } = useMenus();

  // Custom hooks
  const { expandedKeywords, toggleKeywords } = useKeywordToggle();
  const { imageViewerVisible, imageViewerIndex, imageViewerUrls, handleImagePress, closeImageViewer } = useImageViewer();
  const { refreshing, onRefresh } = useRefreshControl(async () => {
    await fetchReviews(restaurantId);
    await fetchMenus(restaurantId);
  });
  const { menuStatistics, statisticsLoading, fetchMenuStatistics } = useMenuStatistics(restaurantId);
  const {
    resummaryModalVisible,
    selectedModel,
    setSelectedModel,
    resummaryLoading,
    availableModels,
    openResummaryModal,
    closeResummaryModal,
    handleResummarize,
    styleGetters,
  } = useResummary(colors, theme);
  const { headerHeight, setHeaderHeight, currentScrollY, handleTabChange } = useScrollToTop(scrollViewRef);

  // ÎèôÏ†Å Ïä§ÌÉÄÏùº Í∞ùÏ≤¥ (ÌÖåÎßàÏôÄ ÏÉÅÌÉúÏóê Îî∞Îùº Î≥ÄÍ≤Ω)
  const dynamicStyles = useMemo(() => ({
    cardBackground: {
      backgroundColor: theme === 'light' ? '#fff' : colors.surface,
    },
    surfaceBackground: {
      backgroundColor: theme === 'light' ? '#f5f5f5' : colors.surface,
    },
    summaryBorder: {
      backgroundColor: theme === 'light' ? '#f5f5ff' : '#1a1a2e',
      borderColor: theme === 'light' ? '#e0e0ff' : '#2d2d44',
    },
  }), [theme, colors]);

  // ÏµúÏã† Í∞íÏùÑ Ï∞∏Ï°∞ÌïòÍ∏∞ ÏúÑÌïú ref
  const activeTabRef = useRef(activeTab);
  const fetchReviewsRef = useRef(fetchReviews);
  const fetchMenusRef = useRef(fetchMenus);
  const fetchMenuStatisticsRef = useRef(fetchMenuStatistics);

  // ref ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    activeTabRef.current = activeTab;
    fetchReviewsRef.current = fetchReviews;
    fetchMenusRef.current = fetchMenus;
    fetchMenuStatisticsRef.current = fetchMenuStatistics;
  });

  // Room ÏûÖÏû•/Ìá¥Ïû• Î∞è ÌÅ¨Î°§ÎßÅ ÏôÑÎ£å ÏΩúÎ∞± ÏÑ§Ï†ï
  useEffect(() => {
    const restaurantIdStr = String(restaurantId);

    // Î†àÏä§ÌÜ†Îûë Î≥ÄÍ≤Ω Ïãú Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï≤òÎ¶¨
    // ÌòÑÏû¨ Ïä§ÌÅ¨Î°§Ïù¥ Ìó§Îçî ÎÜíÏù¥Î≥¥Îã§ ÌÅ¨Î©¥ (Í±¥ÎÑàÎõ¥ ÏÉÅÌÉú) Ìó§Îçî ÎÜíÏù¥Î°ú, ÏïÑÎãàÎ©¥ 0ÏúºÎ°ú
    const targetScrollY = currentScrollY.current >= headerHeight && headerHeight > 0
      ? headerHeight
      : 0;

    console.log('üîç [RestaurantDetailScreen] Î†àÏä§ÌÜ†Îûë Î≥ÄÍ≤Ω Í∞êÏßÄ:', {
      restaurantId: restaurantIdStr,
      currentScrollY: currentScrollY.current,
      headerHeight,
      targetScrollY,
      isSkipped: currentScrollY.current >= headerHeight
    });

    scrollViewRef.current?.scrollTo({ y: targetScrollY, animated: false });

    joinRestaurantRoom(restaurantIdStr);

    // ÌÅ¨Î°§ÎßÅ ÏôÑÎ£å Ïãú Î¶¨Î∑∞/Î©îÎâ¥ Í∞±Ïã† ÏΩúÎ∞± ÏÑ§Ï†ï
    setRestaurantCallbacks({
      onMenuCrawlCompleted: async () => {
        // Î©îÎâ¥Îßå ÌÅ¨Î°§ÎßÅÌïú Í≤ΩÏö∞ Î©îÎâ¥Îßå Í∞±Ïã†
        await fetchMenusRef.current(restaurantId);

        // ÌÜµÍ≥Ñ ÌÉ≠Ïù¥Î©¥ ÌÜµÍ≥ÑÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
        if (activeTabRef.current === 'statistics') {
          await fetchMenuStatisticsRef.current();
        }
      },
      onReviewCrawlCompleted: async () => {
        // Î¶¨Î∑∞ Îã§Ïãú Î°úÎìú (shared ÌõÖ ÏÇ¨Ïö©)
        await fetchReviewsRef.current(restaurantId, 0, false); // offset 0ÏúºÎ°ú Ï¥àÍ∏∞Ìôî

        // ÌÜµÍ≥Ñ ÌÉ≠Ïù¥Î©¥ ÌÜµÍ≥ÑÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
        if (activeTabRef.current === 'statistics') {
          await fetchMenuStatisticsRef.current();
        }
      },
      onReviewSummaryCompleted: async () => {
        // Î¶¨Î∑∞ ÏöîÏïΩ ÏôÑÎ£å ÏãúÏóêÎèÑ Í∞±Ïã†
        await fetchReviewsRef.current(restaurantId, 0, false);

        // ÌÜµÍ≥Ñ ÌÉ≠Ïù¥Î©¥ ÌÜµÍ≥ÑÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
        if (activeTabRef.current === 'statistics') {
          await fetchMenuStatisticsRef.current();
        }
      },
      onReviewCrawlError: async () => {
        await fetchReviewsRef.current(restaurantId, 0, false);
      }
    });

    return () => {
      leaveRestaurantRoom(restaurantIdStr);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps -- headerHeightÎäî ÏùòÎèÑÏ†ÅÏúºÎ°ú Ï†úÏô∏ (Î†àÏä§ÌÜ†Îûë Î≥ÄÍ≤Ω ÏãúÏóêÎßå Ïã§Ìñâ)
  }, [restaurantId, joinRestaurantRoom, leaveRestaurantRoom, setRestaurantCallbacks]);

  // ÌÅ¨Î°§ÎßÅ ÏôÑÎ£å ÌõÑ 3Ï¥à Îí§ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (ÏßÑÌñâÎ•†Ïù¥ Î™®Îëê nullÏù¥ ÎêòÎ©¥ ÏôÑÎ£åÎ°ú Í∞ÑÏ£º)
  useEffect(() => {
    if (isCrawling) {
      wasCrawling.current = true;
    } else if (wasCrawling.current) {
      // ÌÅ¨Î°§ÎßÅÏù¥ ÏôÑÎ£åÎê®
      const timer = setTimeout(() => {
        resetCrawlStatus();
        wasCrawling.current = false;
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [isCrawling, resetCrawlStatus]);

  // ÏöîÏïΩ ÏôÑÎ£å ÌõÑ 3Ï¥à Îí§ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    if (reviewSummaryStatus.status === 'completed') {
      const timer = setTimeout(() => {
        resetSummaryStatus();
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [reviewSummaryStatus.status, resetSummaryStatus]);

  useEffect(() => {
    fetchReviews(restaurantId);
    fetchMenus(restaurantId);
  }, [restaurantId, fetchReviews, fetchMenus]);

  // ÌÜµÍ≥Ñ ÌÉ≠ ÌôúÏÑ±Ìôî Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    if (activeTab === 'statistics') {
      fetchMenuStatistics();
    }
  }, [activeTab, fetchMenuStatistics]);


  // Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ (Î¨¥Ìïú Ïä§ÌÅ¨Î°§)
  const handleScroll = useCallback((event: any) => {
    const { contentOffset, contentSize, layoutMeasurement } = event.nativeEvent;

    // ÌòÑÏû¨ Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï†ÄÏû•
    const previousScrollY = currentScrollY.current;
    currentScrollY.current = contentOffset.y;

    // Ïä§ÌÅ¨Î°§ ÏúÑÏπòÍ∞Ä ÌÅ¨Í≤å Î≥ÄÍ≤ΩÎê† ÎïåÎßå Î°úÍ∑∏ (Îß§ Ïä§ÌÅ¨Î°§ÎßàÎã§ Î°úÍ∑∏ Î∞©ÏßÄ)
    if (Math.abs(previousScrollY - contentOffset.y) > 50) {
      console.log('üìú [RestaurantDetailScreen] Ïä§ÌÅ¨Î°§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏:', {
        scrollY: contentOffset.y,
        headerHeight,
        isSkipped: contentOffset.y >= headerHeight
      });
    }

    const paddingToBottom = 100; // ÌïòÎã®ÏóêÏÑú 100px Ï†ÑÏóê Ìä∏Î¶¨Í±∞
    const isNearBottom = contentOffset.y + layoutMeasurement.height >= contentSize.height - paddingToBottom;

    if (isNearBottom && activeTab === 'review' && !reviewsLoadingMore && !reviewsLoading && hasMoreReviews) {
      loadMoreReviews(restaurantId);
    }
  }, [activeTab, restaurantId, reviewsLoadingMore, reviewsLoading, hasMoreReviews, headerHeight, loadMoreReviews, currentScrollY]);

  return (
    <View style={[styles.container, { backgroundColor: colors.background }]}>
      <ScrollView
        ref={scrollViewRef}
        style={styles.scrollView}
        contentContainerStyle={{ paddingBottom: insets.bottom + 80 }}
        showsVerticalScrollIndicator={false}
        stickyHeaderIndices={[1]} // Ìï≠ÏÉÅ Îëê Î≤àÏß∏ ÏöîÏÜå (ÌÉ≠ Î©îÎâ¥)Î•º stickyÎ°ú Í≥†Ï†ï
        snapToOffsets={headerHeight > 0 ? [0, headerHeight] : undefined}
        snapToEnd={false}
        decelerationRate="normal"
        onScroll={handleScroll}
        scrollEventThrottle={400}
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={onRefresh}
            tintColor={colors.primary}
            colors={[colors.primary]}
          />
        }
      >
        {/* Î†àÏä§ÌÜ†Îûë Ï†ïÎ≥¥ + ÌÅ¨Î°§ÎßÅ ÏÉÅÌÉú Ìó§Îçî (ÎÜíÏù¥ Ï∏°Ï†ïÏö©) */}
        <View onLayout={(e) => {
          const newHeight = e.nativeEvent.layout.height;
          if (newHeight !== headerHeight) {
            console.log('üìè [RestaurantDetailScreen] Ìó§Îçî ÎÜíÏù¥ Î≥ÄÍ≤Ω:', {
              oldHeight: headerHeight,
              newHeight,
              restaurantId
            });
            setHeaderHeight(newHeight);
          }
        }}>
          {/* Î†àÏä§ÌÜ†Îûë Ï†ïÎ≥¥ Ìó§Îçî */}
          <RestaurantDetailHeader
            restaurant={convertRestaurant(restaurant)}
            menuCount={menus.length}
            reviewCount={reviewsTotal}
          />

          {/* ÌÅ¨Î°§ÎßÅ ÏßÑÌñâ ÏÉÅÌÉú */}
          {isCrawling && (
            <CrawlProgressCard
              menuProgress={menuProgress}
              crawlProgress={crawlProgress}
              imageProgress={imageProgress}
              dbProgress={dbProgress}
            />
          )}

          {/* Î¶¨Î∑∞ ÏöîÏïΩ ÏßÑÌñâ ÏÉÅÌÉú */}
          {reviewSummaryStatus.status !== 'idle' && reviewSummaryStatus.status !== 'completed' && (
            <SummaryProgressCard
              summaryProgress={summaryProgress}
            />
          )}
        </View>

        {/* ÌÉ≠ Î©îÎâ¥ - Sticky Í≥†Ï†ï */}
        <View style={{ backgroundColor: colors.background }}>
          <TabMenu
            activeTab={activeTab}
            onTabChange={(tab) => handleTabChange(tab, activeTab, _setActiveTab)}
            menuCount={menus.length}
            reviewCount={reviewsTotal}
          />

          {/* Í∞êÏ†ï ÌïÑÌÑ∞ (Î¶¨Î∑∞ ÌÉ≠ÏóêÏÑúÎßå ÌëúÏãú) */}
          {activeTab === 'review' && (
            <ReviewFilterBar
              sentimentFilter={sentimentFilter}
              onSentimentChange={(filter) => changeSentimentFilter(restaurantId, filter)}
              searchText={searchText}
              onSearchTextChange={setSearchText}
              onSearch={() => changeSearchText(restaurantId, searchText)}
              onClear={() => {
                setSearchText('');
                changeSearchText(restaurantId, '');
              }}
            />
          )}
        </View>

        {/* Î©îÎâ¥ ÌÉ≠ */}
        {activeTab === 'menu' && (
          <MenuTab
            menus={menus}
            menusLoading={menusLoading}
            theme={theme}
            colors={colors}
          />
        )}

        {/* Î¶¨Î∑∞ ÌÉ≠ */}
        {activeTab === 'review' && (
          <ReviewTab
            reviews={reviews.map(convertReview)}
            reviewsLoading={reviewsLoading}
            reviewsLoadingMore={reviewsLoadingMore}
            theme={theme}
            colors={colors}
            dynamicStyles={dynamicStyles}
            expandedKeywords={expandedKeywords}
            toggleKeywords={toggleKeywords}
            renderStars={renderStars}
            handleImagePress={handleImagePress}
            openResummaryModal={openResummaryModal}
          />
        )}

        {/* ÌÜµÍ≥Ñ ÌÉ≠ */}
        {activeTab === 'statistics' && (
          <StatisticsTab
            menuStatistics={menuStatistics}
            statisticsLoading={statisticsLoading}
            colors={colors}
          />
        )}

        {/* ÎÑ§Ïù¥Î≤ÑÎßµ ÌÉ≠ */}
        {activeTab === 'map' && (
          <MapTab
            placeId={restaurant?.place_id}
            onOpenMap={openNaverMap}
          />
        )}
      </ScrollView>

      {/* Ïù¥ÎØ∏ÏßÄ Î∑∞Ïñ¥ Î™®Îã¨ */}
      <ImageViewer
        visible={imageViewerVisible}
        imageUrls={imageViewerUrls}
        imageIndex={imageViewerIndex}
        onClose={closeImageViewer}
      />

      {/* Ïû¨ÏöîÏïΩ Î™®Îã¨ */}
      <ResummaryModal
        visible={resummaryModalVisible}
        onClose={closeResummaryModal}
        selectedModel={selectedModel}
        setSelectedModel={setSelectedModel}
        availableModels={availableModels}
        onConfirm={() => handleResummarize(restaurantId, fetchReviews)}
        loading={resummaryLoading}
        colors={colors}
        getModelOptionStyle={styleGetters.getModelOptionStyle}
        getModelTextStyle={styleGetters.getModelTextStyle}
        getRadioBorderStyle={styleGetters.getRadioBorderStyle}
      />
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  scrollView: {
    flex: 1,
  },
});

export default RestaurantDetailScreen;
